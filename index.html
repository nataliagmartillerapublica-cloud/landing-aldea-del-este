/**
 * Home.tsx
 * Landing minimalista y atractiva para una propiedad en Aldea del Este.
 * Secciones: Hero (texto + grilla de imágenes), stats con íconos, highlights, descripción,
 * bloque comercial con CTA a WhatsApp (con captura de lead rápida), mapa embebido y CTA flotante en mobile.
 */

import React from 'react'
import '../styles/theme.css'
import BrandHeader from '../components/landing/BrandHeader'
import SectionCard from '../components/landing/SectionCard'
import TagChip from '../components/landing/TagChip'
import CTAButton from '../components/landing/CTAButton'
import ImageGrid from '../components/landing/ImageGrid'
import CTAFloat from '../components/landing/CTAFloat'
import EmailLeadForm from '../components/forms/EmailLeadForm'
import { PROPERTY_ID, PROPERTY_TITLE, RECIPIENT_EMAIL, WHATSAPP_PHONE } from '../lib/config'
import FeatureStat from '../components/landing/FeatureStat'
import MapEmbed from '../components/landing/MapEmbed'
import { buildWhatsAppUrl } from '../lib/links'
import QuickWhatsAppLeadModal from '../components/lead/QuickWhatsAppLeadModal'
import { Bed, Bath, CarFront, Ruler, Home as HomeIcon } from 'lucide-react'

/**
 * Construye el enlace a WhatsApp con mensaje y UTM genéricos (fallback).
 * El flujo normal intercepta el clic y abre un modal para capturar el lead primero.
 */
function useWhatsAppHref(): string {
  return buildWhatsAppUrl({
    phone: WHATSAPP_PHONE,
    message:
      'Hola, me interesa la casa de Aldea del Este. Quisiera coordinar una visita. (Enviado desde la landing)',
    utm: {
      utm_source: 'landing',
      utm_medium: 'cta',
      utm_campaign: 'aldea_del_este',
    },
  })
}

/**
 * HomePage
 * Render principal de la landing.
 */
export default function HomePage(): JSX.Element {
  const [showEmailForm, setShowEmailForm] = React.useState(false)
  const [showWaModal, setShowWaModal] = React.useState(false)
  const whatsappHref = useWhatsAppHref()

  /** Lista de imágenes usando los nombres originales. */
  const images = [
    { src: '/img/portada.jpg', alt: 'portada.jpg' },
    { src: '/img/living.jpg', alt: 'living.jpg' },
    { src: '/img/dormitorio.jpg', alt: 'dormitorio.jpg' },
    { src: '/img/cocina.jpg', alt: 'cocina.jpg' },
    { src: '/img/galeria.jpg', alt: 'galeria.jpg' },
    { src: '/img/vista.jpg', alt: 'vista.jpg' },
  ]

  /** Año actual para el footer. */
  const year = new Date().getFullYear()

  /** Interceptar CTA de WhatsApp para capturar lead y luego abrir el chat. */
  const onWhatsAppClick = (e: React.MouseEvent<HTMLAnchorElement>) => {
    e.preventDefault()
    setShowWaModal(true)
  }

  return (
    <div className="min-h-screen bg-[var(--bg)] text-[var(--ink)]">
      <BrandHeader />

      <main className="mx-auto max-w-[1100px] px-4 py-6 md:px-6">
        {/* HERO */}
        <section className="grid grid-cols-1 gap-6 md:grid-cols-2 md:items-start">
          <div>
            <h1 className="mb-2 text-[28px] font-semibold leading-tight md:text-[32px]">
              Casa estilo patagónico – 4 dormitorios – vista al lago (Aldea del Este)
            </h1>
            <p className="text-[15px] leading-relaxed">
              <strong>Aldea del Este – La Morena 4276, Bariloche.</strong> Arquitectura patagónica con vistas al lago
              Nahuel Huapi desde ambientes principales. Lote <strong>874 m²</strong>, superficie cubierta{' '}
              <strong>190 m²</strong>. Cochera doble. Accesos ágiles y cercanía a servicios.
            </p>

            <SectionCard variant="tint" className="mt-4">
              <strong>¿Querés coordinar una visita?</strong>
              <p className="mt-1 text-xs text-[var(--muted)]">
                El botón de contacto está <strong>al final de esta página</strong>. Desde allí te respondo por WhatsApp
                con la ficha y opciones de visita.
              </p>
            </SectionCard>
          </div>

          <div>
            <ImageGrid items={images} />
          </div>
        </section>

        {/* STATS CLAVE */}
        <section className="mt-8">
          <h2 className="mb-3 text-xl font-semibold">Datos clave</h2>
          <div className="grid grid-cols-2 gap-3 md:grid-cols-5">
            <FeatureStat icon={<Bed size={18} />} title="Dormitorios" value="4 + escritorio" />
            <FeatureStat icon={<Bath size={18} />} title="Baños" value="2" />
            <FeatureStat icon={<CarFront size={18} />} title="Cocheras" value="2" />
            <FeatureStat icon={<Ruler size={18} />} title="Cubiertos" value="190 m²" />
            <FeatureStat icon={<HomeIcon size={18} />} title="Lote" value="874 m²" />
          </div>
        </section>

        {/* HIGHLIGHTS */}
        <section className="mt-8">
          <h2 className="mb-3 text-xl font-semibold">Highlights</h2>
          <SectionCard>
            <div>
              <TagChip>Apto crédito hipotecario</TagChip>
              <TagChip>4 dormitorios + escritorio</TagChip>
              <TagChip>2 baños</TagChip>
              <TagChip>Vista al lago</TagChip>
              <TagChip>Lote 874 m²</TagChip>
              <TagChip>Cubiertos 190 m²</TagChip>
              <TagChip>Calefacción por radiadores</TagChip>
              <TagChip>Cochera para 2 autos</TagChip>
              <TagChip>Orientación Norte</TagChip>
              <TagChip>Antigüedad: 23 años</TagChip>
            </div>
          </SectionCard>
        </section>

        {/* DESCRIPCIÓN */}
        <section className="mt-8">
          <h2 className="mb-3 text-xl font-semibold">Descripción breve</h2>
          <div className="space-y-3">
            <p className="text-[15px] leading-relaxed">
              Distribución: living-comedor con hogar y ventanales a vistas, cocina amplia, dormitorio principal y escritorio o Vestidor (en
              planta alta con Vista al Lago), tres dormitorios en PB, dos baños completos y lavadero.
              Exterior: jardín, deck y cochera doble cubierta.
            </p>
            <p className="text-[15px] leading-relaxed">
              Terminaciones en piedra y madera; carpinterías de calidad y buena iluminación natural. Servicios: luz, gas
              y agua. Sistema de calefacción por radiadores en todos los ambientes.
            </p>
          </div>
        </section>

        {/* INFORMACIÓN COMERCIAL + CTA */}
        <section id="consultas" className="mt-8">
          <h2 className="mb-3 text-xl font-semibold">Información comercial</h2>
          <SectionCard>
            <div className="space-y-2 text-[15px]">
              <p>
                <strong>VALOR:</strong> USD 296.000
              </p>
              <p>
                <strong>Condiciones:</strong> apto crédito hipotecario (sujeto a calificación y tasación bancaria).
              </p>
              <p>
                <strong>Visitas:</strong> con coordinación previa.
              </p>
            </div>

            <div className="mt-4 space-y-3">
              {/* Primero: Ver ubicación */}
              <div>
                <a
                  href="#mapa"
                  className="inline-flex items-center justify-center rounded-full border border-[var(--ink)] px-5 py-3 text-sm font-medium text-[var(--ink)] hover:bg-black/5"
                >
                  Ver ubicación
                </a>
              </div>

              {/* Debajo: los dos contactos */}
              <div className="flex flex-wrap gap-3">
                <CTAButton id="whatsapp-buyvisit" href={whatsappHref} variant="primary" onClick={onWhatsAppClick}>
                  Escribime por WhatsApp
                </CTAButton>
                <button
                  type="button"
                  onClick={() => setShowEmailForm((v) => !v)}
                  className="inline-flex items-center justify-center rounded-full border border-[var(--ink)] px-5 py-3 text-sm font-medium text-[var(--ink)] hover:bg-black/5"
                  aria-expanded={showEmailForm}
                  aria-controls="email-form-panel"
                >
                  Prefiero contacto por email
                </button>
              </div>
            </div>

            <p className="mt-2 text-xs text-[var(--muted)]">
              Coordinamos por WhatsApp para agilizar, pero si preferís email, podés usar el formulario alternativo.
            </p>

            {/* Panel plegable con el formulario por email */}
            <div
              id="email-form-panel"
              className={`mt-4 overflow-hidden transition-all duration-300 ${
                showEmailForm ? 'max-h-[1200px] opacity-100' : 'max-h-0 opacity-0'
              }`}
            >
              <EmailLeadForm
                propertyId={PROPERTY_ID}
                propertyTitle={PROPERTY_TITLE}
                recipientEmail={RECIPIENT_EMAIL}
              />
            </div>
          </SectionCard>
        </section>

        {/* MAPA */}
        <section id="mapa" className="mt-8">
          <MapEmbed
            title="Ubicación aproximada"
            query="La Morena 4276, San Carlos de Bariloche, Río Negro, Argentina"
            hint="La ubicación es aproximada. Solicitá la dirección exacta al coordinar la visita."
          />
        </section>
      </main>

      {/* FOOTER */}
      <footer className="border-t border-[var(--line)]">
        <div className="mx-auto max-w-[1100px] px-4 py-4 text-xs text-[var(--muted)] md:px-6">
          © {year} Natalia González · Martillera Pública. Bariloche.
        </div>
      </footer>

      {/* CTA flotante (visible sólo en mobile) */}
      <CTAFloat id="whatsapp-buyvisit-floating" href={whatsappHref} label="Escribime por WhatsApp" onClick={onWhatsAppClick} />

      {/* Modal de lead rápido para WhatsApp */}
      <QuickWhatsAppLeadModal
        open={showWaModal}
        onClose={() => setShowWaModal(false)}
        phone={WHATSAPP_PHONE}
        propertyId={PROPERTY_ID}
        propertyTitle={PROPERTY_TITLE}
      />
    </div>
  )
}
